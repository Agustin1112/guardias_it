{% extends "base.html" %}

{% block content %}

<h3 class="mb-3">ğŸ“‹ Historial de guardias</h3>

{% if current_user.es_admin %}
<!-- FILTRO POR GUARDIA (solo admins) -->
<form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
        <label class="form-label">Filtrar por guardia</label>
        <select name="guardia" class="form-select" onchange="this.form.submit()">
            <option value="">â€” Todas â€”</option>
            {% for g in guardias_disponibles %}
                <option value="{{ g.quien_guardia }}"
                    {% if guardia_filtro == g.quien_guardia %}selected{% endif %}>
                    {{ g.quien_guardia }}
                </option>
            {% endfor %}
        </select>
    </div>

    {% if guardia_filtro %}
    <div class="col-md-2 align-self-end">
        <a href="/dashboard" class="btn btn-secondary">
    Volver al dashboard
</a>

    </div>
    {% endif %}
</form>
{% endif %}

<!-- MENSAJE SI NO HAY GUARDIAS -->
{% if guardias|length == 0 %}
<div class="alert alert-info text-center">
    No hay llamados registrados.
</div>
{% endif %}

<!-- TABLA DE GUARDIAS -->
{% if guardias|length > 0 %}
<table class="table table-striped table-bordered align-middle shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>Fecha del llamado</th>
            <th>Fecha de carga</th>
            <th>QuiÃ©n llamÃ³</th>
            <th>Guardia</th>
            <th>Detalle</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>

    <tbody>
        {% for g in guardias %}
        <tr {% if g.recent %}style="background-color: #eafaf1;"{% endif %}>
            <td>{{ g.fecha_llamado.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>{{ g.fecha_registro.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>{{ g.quien_llamo }}</td>
            <td>{{ g.quien_guardia }}</td>

            <!-- DETALLE -->
            <td>
                {% if g.prioridad == "Alta" %}
                    <span class="badge bg-danger">ğŸ”´ Alta</span>
                {% elif g.prioridad == "Media" %}
                    <span class="badge bg-warning text-dark">ğŸŸ¡ Media</span>
                {% else %}
                    <span class="badge bg-success">ğŸŸ¢ Baja</span>
                {% endif %}

                <div class="mt-1">
                    {{ g.descripcion }}
                </div>

                {% if g.derivado %}
                <div class="mt-1">
                    <span class="badge bg-info text-dark">
                        ğŸ” Derivado a {{ g.derivado_a }}
                    </span>
                </div>
                {% endif %}
            </td>

            <!-- ESTADO -->
            <td>
                <span class="badge
                    {% if g.estado == 'Abierto' %} bg-danger
                    {% elif g.estado == 'En progreso' %} bg-warning text-dark
                    {% elif g.estado == 'Resuelto' %} bg-success
                    {% elif g.estado == 'Cerrado' %} bg-secondary
                    {% else %} bg-light text-dark
                    {% endif %}">
                    {{ g.estado }}
                </span>
            </td>

            <!-- ACCIONES -->
            <td>
                <a href="{{ url_for('editar_guardia', guardia_id=g.id) }}"
   class="btn btn-sm btn-primary">
   âœï¸ Editar
</a>

            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- PAGINACIÃ“N (admins y guardias comunes) -->
{% if total_pages > 1 %}
<nav aria-label="PaginaciÃ³n">
    <ul class="pagination justify-content-center mt-3">

        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link"
               href="?page={{ page-1 }}{% if guardia_filtro %}&guardia={{ guardia_filtro }}{% endif %}">
               Anterior
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">Anterior</span>
        </li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link"
               href="?page={{ p }}{% if guardia_filtro %}&guardia={{ guardia_filtro }}{% endif %}">
               {{ p }}
            </a>
        </li>
        {% endfor %}

        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link"
               href="?page={{ page+1 }}{% if guardia_filtro %}&guardia={{ guardia_filtro }}{% endif %}">
               Siguiente
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">Siguiente</span>
        </li>
        {% endif %}

    </ul>
</nav>
{% endif %}

{% endblock %}
