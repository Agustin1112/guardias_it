{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">üìã Historial de guardias</h3>

<style>
    mark {
        background-color: #ffe066;
        padding: 0 4px;
        border-radius: 4px;
        font-weight: 600;
    }
</style>

<form method="get" class="row g-3 mb-4 align-items-end">

    {% if current_user.es_admin %}
    <div class="col-md-3">
        <label class="form-label">Filtrar por guardia</label>
        <select name="guardia" class="form-select">
            <option value="">‚Äî Todas ‚Äî</option>
            {% for g in guardias_disponibles %}
                <option value="{{ g.quien_guardia }}"
                    {% if guardia_filtro == g.quien_guardia %}selected{% endif %}>
                    {{ g.quien_guardia }}
                </option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div class="col-md-5">
        <label class="form-label">Buscar texto</label>
        <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Ej: problema para imprimir etiquetas"
            value="{{ q or '' }}"
        >
    </div>

    <div class="col-md-2">
        <button class="btn btn-primary w-100">üîç Buscar</button>
    </div>

    <div class="col-md-2">
        <a href="/" class="btn btn-secondary w-100">Limpiar</a>
    </div>

</form>

{% if guardias|length == 0 %}
<div class="alert alert-info text-center">
    No hay llamados registrados.
</div>
{% endif %}

{% if guardias|length > 0 %}
<table class="table table-striped table-bordered align-middle shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>Fecha llamado</th>
            <th>Fecha carga</th>
            <th>Qui√©n llam√≥</th>
            <th>Guardia</th>
            <th>Detalle</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>

    <tbody>
        {% for g in guardias %}
        <tr {% if g.recent %}style="background-color:#eafaf1"{% endif %}>
            <td>{{ g.fecha_llamado.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>{{ g.fecha_registro.strftime('%d/%m/%Y %H:%M') }}</td>

            <td>{{ g.quien_llamo_html | safe }}</td>
            <td>{{ g.quien_guardia }}</td>

            <td>
                <span class="badge
                    {% if g.prioridad == 'Alta' %}bg-danger
                    {% elif g.prioridad == 'Media' %}bg-warning text-dark
                    {% else %}bg-success{% endif %}">
                    {{ g.prioridad }}
                </span>

                <div class="mt-1">
                    {{ g.descripcion_html | safe }}
                </div>

                {% if g.derivado_a_html %}
                <div class="mt-1">
                    <span class="badge bg-info text-dark">
                        üîÅ {{ g.derivado_a_html | safe }}
                    </span>
                </div>
                {% endif %}
            </td>

            <td>
                <span class="badge
                    {% if g.estado == 'Abierto' %}bg-danger
                    {% elif g.estado == 'En progreso' %}bg-warning text-dark
                    {% elif g.estado == 'Resuelto' %}bg-success
                    {% else %}bg-secondary{% endif %}">
                    {{ g.estado }}
                </span>
            </td>

            <td>
                <a href="{{ url_for('editar_guardia', guardia_id=g.id) }}"
                   class="btn btn-sm btn-primary">
                    ‚úèÔ∏è Editar
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if total_pages > 1 %}
<nav>
    <ul class="pagination justify-content-center mt-3">
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link"
               href="?page={{ p }}
               {% if guardia_filtro %}&guardia={{ guardia_filtro }}{% endif %}
               {% if q %}&q={{ q }}{% endif %}">
                {{ p }}
            </a>
        </li>
        {% endfor %}
    </ul>
</nav>
{% endif %}

{% endblock %}
