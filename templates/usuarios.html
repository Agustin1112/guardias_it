{% extends "base.html" %}

{% block content %}
<h3 class="mb-3">Usuarios</h3>

<a href="{{ url_for('nuevo_usuario') }}" class="btn btn-success mb-3">Nuevo Usuario</a>

<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Username</th>
            <th>Admin</th>
            <th>Activo</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for u in usuarios %}
        <tr id="user-{{ u.id }}">
            <td>{{ u.username }}</td>
            <td>
                <span class="badge {% if u.es_admin %}bg-warning text-dark{% else %}bg-secondary{% endif %}" id="admin-badge-{{ u.id }}">
                    {% if u.es_admin %}Admin{% else %}Usuario{% endif %}
                </span>
            </td>
            <td>
                <span class="badge {% if u.activo %}bg-success{% else %}bg-danger{% endif %}" id="activo-badge-{{ u.id }}">
                    {% if u.activo %}Activo{% else %}Inactivo{% endif %}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="toggleAdmin({{ u.id }})">Cambiar rol</button>
                <button class="btn btn-sm btn-warning" onclick="toggleActivo({{ u.id }})">Activar/Desactivar</button>
                <a href="{{ url_for('editar_usuario', user_id=u.id) }}" class="btn btn-sm btn-secondary">Editar</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
async function toggleAdmin(userId) {
    const response = await fetch(`/usuarios/${userId}/toggle-admin`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    });
    if (response.ok) {
        const badge = document.getElementById(`admin-badge-${userId}`);
        if (badge.textContent.trim() === 'Admin') {
            badge.textContent = 'Usuario';
            badge.className = 'badge bg-secondary';
        } else {
            badge.textContent = 'Admin';
            badge.className = 'badge bg-warning text-dark';
        }
    } else {
        alert('Error al cambiar el rol del usuario');
    }
}

async function toggleActivo(userId) {
    const response = await fetch(`/usuarios/toggle/${userId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    });
    if (response.ok) {
        const badge = document.getElementById(`activo-badge-${userId}`);
        if (badge.textContent.trim() === 'Activo') {
            badge.textContent = 'Inactivo';
            badge.className = 'badge bg-danger';
        } else {
            badge.textContent = 'Activo';
            badge.className = 'badge bg-success';
        }
    } else {
        alert('Error al cambiar el estado del usuario');
    }
}
</script>
{% endblock %}
