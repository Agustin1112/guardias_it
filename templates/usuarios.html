{% extends "base.html" %}

{% block content %}
<h3 class="mb-3">Panel de Usuarios</h3>

<table class="table table-striped table-bordered mb-4">
    <thead class="table-dark">
        <tr>
            <th>Usuario</th>
            <th>Admin</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for u in usuarios %}
        <tr id="user-{{ u.id }}">
            <td>{{ u.username }}</td>

            <td>
                <span class="badge {% if u.es_admin %}bg-warning text-dark{% else %}bg-secondary{% endif %}"
                      id="admin-badge-{{ u.id }}">
                    {% if u.es_admin %}Sí{% else %}No{% endif %}
                </span>
            </td>

            <td>
                <span class="badge {% if u.activo %}bg-success{% else %}bg-danger{% endif %}"
                      id="activo-badge-{{ u.id }}">
                    {% if u.activo %}Activo{% else %}Inactivo{% endif %}
                </span>
            </td>

            <td>
                <button class="btn btn-sm btn-primary"
                        onclick="toggleAdmin({{ u.id }})">
                    Cambiar rol
                </button>

                <button class="btn btn-sm btn-warning"
                        onclick="toggleActivo({{ u.id }})">
                    Activar / Desactivar
                </button>

                <a href="{{ url_for('editar_usuario', user_id=u.id) }}"
                   class="btn btn-sm btn-secondary">
                    Editar
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<hr class="my-4">

<h4>Crear nuevo usuario</h4>

<form method="POST" action="{{ url_for('nuevo_usuario') }}" class="mt-3">
    <div class="mb-3">
        <label class="form-label">Nombre de usuario</label>
        <input type="text"
               name="username"
               class="form-control"
               required>
    </div>

    <div class="mb-3">
        <label class="form-label">Contraseña</label>
        <input type="password"
               name="password"
               class="form-control"
               required>
    </div>

    <div class="form-check mb-3">
        <input class="form-check-input"
               type="checkbox"
               name="es_admin"
               id="es_admin">
        <label class="form-check-label" for="es_admin">
            Administrador
        </label>
    </div>

    <button class="btn btn-success">
        Crear usuario
    </button>
</form>

<script>
async function toggleAdmin(userId) {
    const response = await fetch(`/usuarios/${userId}/toggle-admin`, {
        method: 'POST'
    });

    if (response.ok) {
        const badge = document.getElementById(`admin-badge-${userId}`);
        if (badge.textContent.trim() === 'Sí') {
            badge.textContent = 'No';
            badge.className = 'badge bg-secondary';
        } else {
            badge.textContent = 'Sí';
            badge.className = 'badge bg-warning text-dark';
        }
    }
}

async function toggleActivo(userId) {
    const response = await fetch(`/usuarios/toggle/${userId}`, {
        method: 'POST'
    });

    if (response.ok) {
        const badge = document.getElementById(`activo-badge-${userId}`);
        if (badge.textContent.trim() === 'Activo') {
            badge.textContent = 'Inactivo';
            badge.className = 'badge bg-danger';
        } else {
            badge.textContent = 'Activo';
            badge.className = 'badge bg-success';
        }
    }
}
</script>

{% endblock %}
